name: Link Checker

on:
  push:
    env:
      IS_PR: false
  pull_request:
    env:
      IS_PR: true

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7]

    steps:
    - uses: actions/checkout@v1
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install dactyl

    - name: Check for Conflict Markers
      run: |
        tool/conflictmarkers.sh

    - name: Build docs
      run: |
        echo '{"github_forkurl": "https://github.com/'"${{ github.repository }}"'", "github_branch": "'"${{ github.head_ref }}"'", "github_pr_id": "'"${{ github.event.number }}"'", "is_pr_build": '"${{ IS_PR }}"'}' > dactyl_vars.json
        tool/build_all_langs.sh --vars dactyl_vars.json

    - name: Run Dactyl Link Checker
      run: |
        dactyl_link_checker -q
